%# -*- coding: utf-8 -*-
%!TEX encoding = UTF-8 Unicode
%!TEX TS-program = xelatex
% vim:ts=4:sw=4
%
% 以上设定默认使用 XeLaTex 编译，并指定 Unicode 编码，供 TeXShop 自动识别


\newcommand\mymainfont{Noto Serif}%{Times New Roman} %{DejaVu Serif}
\newcommand\mymonofont{DejaVu Sans Mono}%{FreeMono} %{WenQuanYi Micro Hei Mono} %{Monaco}
\newcommand\myboldfont{DejaVu Sans Mono} %{WenQuanYi Micro Hei Mono}%{AR PL UKai CN}%{YaHei Consolas Hybrid}%{黑体}%{標楷體}
\newcommand\mysansfont{DejaVu Sans}%{FreeSans}
\newcommand\myitalicfont{DejaVu Serif}%{Times New Roman} %{Garamond}

\newcommand\mycjkboldfont{Microsoft YaHei} %{WenQuanYi Micro Hei Mono}%{Adobe Heiti Std}%{AR PL UKai CN}%{YaHei Consolas Hybrid}%{黑体}%{標楷體}
\newcommand\mycjkitalicfont{全字庫正楷體} %{Adobe Kaiti Std}
\newcommand\mycjkmainfont{WenyueType GutiFangsong (Noncommercial Use)}%{全字庫正楷體} %{Adobe Song Std} %{AR PL UMing CN}%{仿宋}%{宋体}%{新宋体}%{文鼎ＰＬ新宋}%
\newcommand\mycjksansfont{MingLiU} %{Adobe Ming Std}
\newcommand\mycjkmonofont{DejaVu Sans YuanTi Mono}%{WenQuanYi Micro Hei Mono}%{AR PL UMing CN}%{WenQuanYi Micro Hei Mono}


%\usepackage[nofonts]{ctex} %adobefonts
\usepackage[adobefonts]{ctex} %adobefonts
%\usepackage[fallback]{xeCJK}


\newCJKfontfamily{\mykaiti}{全字庫正楷體}%{AR PL UKai TW}%{全字庫正楷體}
\newCJKfontfamily{\myfangsong}{WenyueType GutiFangsong (Noncommercial Use)}



\usepackage{ifthen}
\usepackage{ifpdf}
\usepackage{ifxetex}
\usepackage{ifluatex}


\usepackage{color}
\usepackage[rgb]{xcolor}



\xeCJKsetup{AutoFallBack = true} % you have to use this, since fallback won't work as the xeCJK option after the ctex

\PassOptionsToPackage{
    BoldFont,  % 允許粗體
    SlantFont, % 允許斜體
    CJKnumber,
    CJKtextspaces,
    }{xeCJK}
\defaultfontfeatures{Mapping=tex-text} % 如果沒有它，會有一些 tex 特殊字符無法正常使用，比如連字符。

\xeCJKsetup {
    CheckSingle = true,
    AutoFakeBold = false,
AutoFakeSlant = false,
    CJKecglue = {},
    PunctStyle = kaiming,
KaiMingPunct+ = {：；},
}

\PassOptionsToPackage{CJKchecksingle}{xeCJK}
%\defaultCJKfontfeatures{Scale=0.5}
%\LoadClass[c5size,openany,nofonts]{ctexbook}
\XeTeXlinebreaklocale "zh"                      % 重要，使得中文可以正確斷行！
\XeTeXlinebreakskip = 0pt plus 1pt minus 0.1pt  % 给予TeX断行一定自由度
\linespread{1.3}                                % 1.3倍行距

\setCJKmainfont[BoldFont=\mycjkboldfont, ItalicFont=\mycjkitalicfont]{\mycjkmainfont}
\setCJKsansfont{\mycjksansfont}%{Adobe Ming Std} %{AR PL UMing CN} %{Microsoft YaHei}
\setCJKmonofont{\mycjkmonofont}



\ifxetex % xelatex
\else
    %The cmap package is intended to make the PDF files generated by pdflatex "searchable and copyable" in acrobat reader and other compliant PDF viewers.
    \usepackage{cmap}%
\fi
% ============================================
% Check for PDFLaTeX/LaTeX
% ============================================
\newcommand{\outengine}{xetex}
\newif\ifpdf
\ifx\pdfoutput\undefined
  \pdffalse % we are not running PDFLaTeX
  \ifxetex
    \renewcommand{\outengine}{xetex}
  \else
    \renewcommand{\outengine}{dvipdfmx}
  \fi
\else
  \pdfoutput=1 % we are running PDFLaTeX
  \pdftrue
  \usepackage{thumbpdf}
  \renewcommand{\outengine}{pdftex}
  \pdfcompresslevel=9
\fi
\usepackage[\outengine,
    bookmarksnumbered, %dvipdfmx
    %% unicode, %% 不能有unicode选项，否则bookmark会是乱码
    colorlinks=true,
    citecolor=red,
    urlcolor=blue,        % \href{...}{...} external (URL)
    filecolor=red,      % \href{...} local file
    linkcolor=black, % \ref{...} and \pageref{...}
    breaklinks,
    pdftitle={\doctitle},
    pdfauthor={\docauthor},
    pdfsubject={\docsubject},
    pdfkeywords={\dockeywords},
    pdfproducer={Latex with hyperref},
    pdfcreator={pdflatex},
    %%pdfadjustspacing=1,
    pdfborder=1,
    pdfpagemode=UseNone,
    pagebackref,
    bookmarksopen=true]{hyperref}

% --------------------------------------------
% Load graphicx package with pdf if needed 
% --------------------------------------------
\ifxetex    % xelatex
    \usepackage{graphicx}
\else
    \ifpdf
        \usepackage[pdftex]{graphicx}
        \pdfcompresslevel=9
    \else
        \usepackage{graphicx} % \usepackage[dvipdfm]{graphicx}
    \fi
\fi

%\newCJKfontfamily{\yanti}{\mycjkmainfont}
%\newenvironment{shicibody}{%
%\begin{verse}\centering\yanti\large\hspace{13pt}}{\end{verse}}


\usepackage{xstring}

%The baseline-skip should be set to roughly 1.2x the font size.
%\fontsize{size}{baselineskip}
%\fontsize{50}{60}

% 计算所能容纳的字数
\newcommand\shizishow[1]{
\StrLen{#1}[\mystringlen]
%\def\mythresh{1}
    \ifthenelse{\mystringlen < 2}{
        {\fontsize{130}{156} #1}
    }{ \ifthenelse{\mystringlen < 3}{
        {\fontsize{110}{122} #1}%{\fontsize{100}{120} #1}
    }{ \ifthenelse{\mystringlen < 4}{
        {\fontsize{78}{94} #1}%{\fontsize{90}{108} #1}
    }{ \ifthenelse{\mystringlen < 5}{
        {\fontsize{55}{66} #1}
    }{ \ifthenelse{\mystringlen < 7}{
        {\fontsize{70}{84} #1}
    }{ \ifthenelse{\mystringlen < 9}{
        {\fontsize{55}{66} #1}
    }{ \ifthenelse{\mystringlen < 16}{
        {\zihao{0} #1} %5x4=20
    }{ \ifthenelse{\mystringlen < 49}{
        {\zihao{1} #1} % 8x6=48
    }{ \ifthenelse{\mystringlen < 55}{
        {\Huge #1} % 9x6=54
    }{ \ifthenelse{\mystringlen < 61}{
        {\zihao{2} #1} % 10x6=60
    }{ \ifthenelse{\mystringlen < 78}{
        {\huge #1} % 11x7=77
    }{ \ifthenelse{\mystringlen < 105}{
        {\LARGE #1} % 13x8=104
    }{ \ifthenelse{\mystringlen < 113}{
        {\zihao{3} #1} % 14x8=112
    }{ \ifthenelse{\mystringlen < 129}{
        {\Large #1} % 16x8=128 %{\zihao{4} #1} % 16x8=128
    }{ \ifthenelse{\mystringlen < 153}{
        {\large #1} % 19x8=152, or 19x9=171
    }{ \ifthenelse{\mystringlen < 198}{
        {\zihao{5} #1} % 22x9=198
    }{ \ifthenelse{\mystringlen < 207}{
        {\normalsize #1} % 23x9=207
    }{ \ifthenelse{\mystringlen < 234}{
        {\small #1} % 26x9=234
    }{ \ifthenelse{\mystringlen < 261}{
        {\footnotesize #1} % 29x9=261
    }{ \ifthenelse{\mystringlen < 279}{
        {\zihao{6} #1} % 31x9=279
    }{ \ifthenelse{\mystringlen < 297}{
        {\scriptsize #1} % 33x9=297
    }{ \ifthenelse{\mystringlen < 378}{
        {\zihao{7} #1} % 42x9=378
    }{
        {\tiny #1} % 46x9=414 %{\zihao{8} #1} % 46x9=414
    }}}}}}}}}}}}}}}}}}}}}}
}

% 计算包含拼音时所能容纳的字数
\newcommand\shizipy[1]{
\StrLen{#1}[\mystringlen]
\xpinyin*{
    \ifthenelse{\mystringlen < 6}{
        {\zihao{0} #1} %5x4=20
    }{ \ifthenelse{\mystringlen < 18}{
        {\zihao{1} #1} % 8x6=48
    }{ \ifthenelse{\mystringlen < 22}{
        {\Huge #1} % 9x6=54
    }{ \ifthenelse{\mystringlen < 31}{
        {\zihao{2} #1} % 10x6=60
    }{ \ifthenelse{\mystringlen < 34}{
        {\huge #1} % 11x7=77
    }{ \ifthenelse{\mystringlen < 53}{
        {\LARGE #1} % 13x8=104
    }{ \ifthenelse{\mystringlen < 57}{
        {\zihao{3} #1} % 14x8=112
    }{ \ifthenelse{\mystringlen < 65}{
        {\Large #1} % 16x8=128 %{\zihao{4} #1} % 16x8=128
    }{ \ifthenelse{\mystringlen < 77}{
        {\large #1} % 19x8=152, or 19x9=171
    }{ \ifthenelse{\mystringlen < 89}{
        {\zihao{5} #1} % 22x9=198
    }{ \ifthenelse{\mystringlen < 93}{
        {\normalsize #1} % 23x9=207
    }{ \ifthenelse{\mystringlen < 105}{
        {\small #1} % 26x9=234
    }{ \ifthenelse{\mystringlen < 117}{
        {\footnotesize #1} % 29x9=261
    }{ \ifthenelse{\mystringlen < 125}{
        {\zihao{6} #1} % 31x9=279
    }{ \ifthenelse{\mystringlen < 133}{
        {\scriptsize #1} % 33x9=297
    }{ \ifthenelse{\mystringlen < 169}{
        {\zihao{7} #1} % 42x9=378
    }{
        {\tiny #1} % 46x9=414 %{\zihao{8} #1} % 46x9=414
    }}}}}}}}}}}}}}}}
}
}

% 计算在comment中（三字经）能容纳的字数
\newcommand\sanzicomments[1]{
\StrLen{#1}[\mystringlen]
%\def\mythresh{1}
    \ifthenelse{\mystringlen < 7}{
        {\zihao{0} #1} %5x4=20
    }{ \ifthenelse{\mystringlen < 22}{
        {\zihao{1} #1} % 8x6=48
    }{ \ifthenelse{\mystringlen < 25}{
        {\Huge #1} % 9x6=54
    }{ \ifthenelse{\mystringlen < 38}{
        {\zihao{2} #1} % 10x6=60
    }{ \ifthenelse{\mystringlen < 42}{ %
        {\huge #1} % 11x7=77
    }{ \ifthenelse{\mystringlen < 63}{
        {\LARGE #1} % 13x8=104
    }{ \ifthenelse{\mystringlen < 64}{
        {\zihao{3} #1} % 14x8=112
    }{ \ifthenelse{\mystringlen < 87}{
        {\Large #1} % 16x8=128 %{\zihao{4} #1} % 16x8=128
    }{ \ifthenelse{\mystringlen < 125}{
        {\large #1} % 19x8=152, or 19x9=171
    }{ \ifthenelse{\mystringlen < 173}{
        {\zihao{5} #1} % 22x9=198
    }{ \ifthenelse{\mystringlen < 205}{
        {\normalsize #1} % 23x9=207
    }{ \ifthenelse{\mystringlen < 232}{
        {\small #1} % 26x9=234
    }{ \ifthenelse{\mystringlen < 259}{
        {\footnotesize #1} % 29x9=261
    }{ \ifthenelse{\mystringlen < 277}{
        {\zihao{6} #1} % 31x9=279
    }{ \ifthenelse{\mystringlen < 295}{
        {\scriptsize #1} % 33x9=297
    }{ \ifthenelse{\mystringlen < 376}{
        {\zihao{7} #1} % 42x9=378
    }{
        {\tiny #1} % 46x9=414 %{\zihao{8} #1} % 46x9=414
    }}}}}}}}}}}}}}}}
}



% 诗词
\newcommand\shici[5]{
\begin{flashcard}[#1 -- #2 （#3） #4]{%
{\mykaiti \Large {#5}} %\\
}
\vspace*{\stretch{1}}
\begin{center}

{\mykaiti \zihao{1} {#2}}\\ \vspace*{\stretch{.5}}
{\large（#3）}\\ \vspace*{\stretch{.25}}
{\LARGE #4}

\end{center}
\vspace*{\stretch{1}}
\end{flashcard}
}



% 识字

%\usepackage[overlap,CJK]{ruby}
\usepackage{xpinyin}

% 如果字数多，则略写
\newcommand\shizititle[2]{
  \StrLen{(#1) #2}[\mystringlen]%
  \ifthenelse{\mystringlen > 24}{
    \StrLeft{(#1) #2}{20}......\StrRight{(#1) #2}{4}
  }{
  (#1) #2
  }
}
\newcommand\shizi[3]{
\begin{flashcard}[\shizititle{#1}{#2}]{ %
{\mykaiti \shizipy{#2}}

{\myfangsong \normalsize #3} %
} %
\vspace*{\stretch{1}}
\begin{center}
%ēéěè
%\ruby{莉}{li}
%\xpinyin*{床前明月光，疑是地上霜。举头望明月，低头思故乡。}
%\begin{pinyinscope}
%床前明月光，疑是地上霜。举头望明月，低头思故乡。
%\end{pinyinscope}

{\mykaiti \shizishow{#2}}

\end{center}
\vspace*{\stretch{1}}
\end{flashcard}
}




% 三字经
\newcommand\sanzijing[3]{
\begin{flashcard}[]{\mykaiti \fontsize{26}{\baselineskip}\selectfont \xpinyin*{#1}}%{\Huge \xpinyin*{#1}}
\vspace*{\stretch{1}}
%\begin{center}
%\normalsize
{\myfangsong
\sanzicomments{
【解释】 #2

〖解读〗 #3
}}
%\end{center}
\vspace*{\stretch{1}}
\end{flashcard}
}





\newcommand\docshowcopyright{
\begin{flashcard}[Copyright \& License]{Copyright \copyright \, 2014 Yunhui Fu\\
Some rights reserved.}
\vspace*{\stretch{1}}
These flashcards and the accompanying \LaTeX \, source code are licensed
under a Creative Commons Attribution--NonCommercial--ShareAlike 2.5 License.  
For more information, see creativecommons.org.  You can contact the author at:
\begin{center}
\begin{small}\tt yhfudev at gmail com\end{small}

\medskip
File last updated on \today, \\
at \currenttime
\end{center}
\vspace*{\stretch{1}}
\end{flashcard}

\begin{flashcard}[版权申明]{版权所有 \copyright \, 2014 Yunhui Fu\\
有些版权保留.}
\vspace*{\stretch{1}}
闪卡及其 \LaTeX \, 源代码在
署名-相同方式共享 2.5 下保护.
参见 creativecommons.org.  你可以联系作者：
\begin{center}
\begin{small}\tt yhfudev at gmail com\end{small}

\medskip
文件最近更新： \today, \\
\currenttime
\end{center}
\vspace*{\stretch{1}}
\end{flashcard}
}






\newcommand\docshowtitle[3]{
\begin{flashcard}[]{ %
{\mykaiti \Huge{#1}}

{\myfangsong \normalsize #2} %
} %
\vspace*{\stretch{1}}
\begin{center}

{\mykaiti \shizishow{#3}}

\end{center}
\vspace*{\stretch{1}}
\end{flashcard}
}





